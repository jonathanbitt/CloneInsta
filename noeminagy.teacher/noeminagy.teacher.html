<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clone Instagram - Desktop (grid 4 por linha)</title>
  <style>
    :root{--bg:#fafafa;--card:#fff;--muted:#8e8e8e;--accent:#0095f6}
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#111}
    header{height:66px;background:#fff;border-bottom:1px solid #dbdbdb;display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:16px}
    .brand h1{font-family:'Grand Hotel',cursive;font-size:30px;margin:0}
    .search{width:300px;display:flex;align-items:center;gap:12px;}
    .container{max-width:980px;margin:28px auto;}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:24px}
    .card{background:var(--card);border:1px solid #dbdbdb;border-radius:3px;padding:8px;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
    .thumb{width:100%;aspect-ratio:319/486;object-fit:cover;border-radius:2px;display:block;background:#efefef}
    .controls{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    select, input, button{font-size:14px}
    select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;background:#fff}
    input[type="text"]{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px}
    button{align-self:flex-end;padding:8px 12px;border-radius:4px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .tag-list{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .tag-list span{background:#eee;padding:4px 8px;border-radius:12px;font-size:12px}
    .loading{display:flex;align-items:center;justify-content:center;padding:16px;color:var(--muted)}
    @media(min-width:1180px){.page{display:block};.container{max-width:100%;margin:28px;}}
    @media(max-width:1000px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:460px){.grid{grid-template-columns:repeat(1,1fr)}}
    .spinner{width:28px;height:28px;border-radius:50%;border:4px solid #e9e9e9;border-top-color:var(--muted);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <div class="brand"><h1>Instagram</h1></div>
    <div class="search">
      <input type="search" placeholder="Pesquisar" style="width:200px;padding:8px;border-radius:6px;border:1px solid #dbdbdb">
    <select id="filtro-selecao" style="padding:6px;border-radius:6px;border:1px solid #ccc;">
  <option value="">-- Todos --</option>
  <option value="nao-classificado">N√£o Classificado</option>
  <option value="relevante">Relevante</option>
  <option value="irrelevante">Irrelevante</option>
  <option value="lixo">Lixo</option>
  <option value="utilizado">Utilizado</option>
</select>
    </div>
    <nav style="display:flex;gap:12px;align-items:center">
      <button id="btn-atualizar-json" style="padding:8px 10px;border-radius:6px;border:1px solid #dbdbdb;background:#fff">Atualizar JSON</button>
      <button aria-label="Novo" style="padding:8px 10px;border-radius:6px;border:1px solid #dbdbdb;background:#fff">Novo</button>
      <button aria-label="Perfil" style="padding:8px 10px;border-radius:6px;border:1px solid #dbdbdb;background:#fff">Perfil</button>
    </nav>
  </header>

  <main class="container page">
    <section id="feed" class="grid" aria-live="polite" aria-busy="false"></section>
  </main>

  <div id="loadingIndicator" class="loading" style="display:none">
    <div class="spinner" aria-hidden="true"></div>
    <span style="margin-left:8px">Carregando...</span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { 
      getFirestore, collection, doc, setDoc, getDoc, addDoc, query, where, getDocs, updateDoc, arrayUnion 
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // =============================================================================
    // CONFIGURA√á√ÉO DA COLE√á√ÉO - MODIFIQUE AQUI PARA USAR OUTRA COLE√á√ÉO
    // =============================================================================
    const NOME_COLECAO = "noeminagy.teacher"; // ‚Üê Altere este valor para outra cole√ß√£o
    const NOME_JSON = "noeminagy.teacher.json"; // ‚Üê Altere este valor para outro JSON
    // =============================================================================

    const firebaseConfig = {
      apiKey: "AIzaSyCNgDqkqhsFQY7bfrWK2_VPtGUoEyyIBq4",
      authDomain: "trechos-c7fba.firebaseapp.com",
      projectId: "trechos-c7fba",
      storageBucket: "trechos-c7fba.appspot.com",
      messagingSenderId: "334052038527",
      appId: "1:334052038527:web:797e8967eaef7b198a2c4a",
      measurementId: "G-FL2Q1KLJMT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const feed = document.getElementById('feed');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const filtroSelect = document.getElementById("filtro-selecao");

    // Atualiza o t√≠tulo da p√°gina com o nome da cole√ß√£o
    document.title = `Clone Instagram - ${NOME_COLECAO}`;

    // Cache global em mem√≥ria
    let cacheGlobal = null;

    async function carregarDadosInteligente() {
      const AGORA = Date.now();
      const ULTIMA_SYNC = parseInt(localStorage.getItem('ultimaSincronizacao') || '0');
      const CACHE_LOCAL = localStorage.getItem(`${NOME_COLECAO}_cache`);
      
      // Se j√° carregou nesta sess√£o, usa cache em mem√≥ria
      if (cacheGlobal) {
        return cacheGlobal;
      }

      // Se tem cache local recente (menos de 5 minutos), usa ele
      if (CACHE_LOCAL && (AGORA - ULTIMA_SYNC) < 300000) {
        console.log('Usando cache local');
        cacheGlobal = JSON.parse(CACHE_LOCAL);
        return cacheGlobal;
      }
      
      // Sen√£o, busca do JSON local
      try {
        console.log(`Buscando dados do JSON local: ${NOME_JSON}`);
        const dados = await carregarDoJSON();
        
        // Atualiza cache
        cacheGlobal = dados;
        localStorage.setItem(`${NOME_COLECAO}_cache`, JSON.stringify(dados));
        localStorage.setItem('ultimaSincronizacao', AGORA.toString());
        
        return dados;
      } catch (error) {
        console.error('Erro ao carregar do JSON:', error);
        
        // Fallback para cache local
        if (CACHE_LOCAL) {
          cacheGlobal = JSON.parse(CACHE_LOCAL);
          return cacheGlobal;
        }
        throw error;
      }
    }

    async function carregarDoJSON() {
      try {
        const response = await fetch(`./${NOME_JSON}`);
        
        if (!response.ok) {
          throw new Error(`JSON response: ${response.status}`);
        }
        
        const data = await response.json();
        const dadosMap = {};
        
        // Processa todos os dados do JSON
        data.forEach(item => {
          if (item.nome) {
            dadosMap[item.nome] = {
              link: item.link || '#',
              selecao: item.selecao || '',
              tags: item.tags || [],
              imagem: item.imagem || `tub/${item.nome}.png`,
              timestamp: item.timestamp
            };
          }
        });
        
        return dadosMap;
      } catch (error) {
        console.error("Erro ao carregar JSON:", error);
        return {};
      }
    }

    function aplicarFiltro() {
      const valorFiltro = filtroSelect.value;
      const cards = feed.querySelectorAll(".card");
      
      cards.forEach(card => {
        const select = card.querySelector("select");
        const selectValue = select.value;
        
        switch(valorFiltro) {
          case "nao-classificado":
            card.style.display = (selectValue === "" || selectValue === "-- Marcar --") ? "block" : "none";
            break;
          case "":
            card.style.display = "block"; // Todos
            break;
          default:
            card.style.display = selectValue === valorFiltro ? "block" : "none";
        }
      });
    }

    filtroSelect.addEventListener("change", aplicarFiltro);

    function createCard(nome, dadosJSON) {
      const card = document.createElement('article');
      card.className = 'card';
      
      // Usa dados do JSON
      const linkUrl = dadosJSON.link || '#';
      const selecaoSalva = dadosJSON.selecao || '';
      const tagsSalvas = dadosJSON.tags || [];

      // Container para a imagem e o n√∫mero
      const imageContainer = document.createElement('div');
      imageContainer.style.position = 'relative';
      imageContainer.style.display = 'inline-block';
      imageContainer.style.width = '100%';

      // Link + imagem
      const link = document.createElement('a');
      link.href = linkUrl;
      link.target = '_blank';
      link.style.display = 'block';

      const img = document.createElement('img');
      img.className = 'thumb';
      img.src = dadosJSON.imagem || `tub/${nome}.png`;
      img.alt = `Thumbnail ${nome}`;
      img.style.width = '100%';
      img.style.height = 'auto';
      img.style.display = 'block';
      link.appendChild(img);

      // N√∫mero sobre a imagem
      const numberLabel = document.createElement('div');
      numberLabel.textContent = nome;
      numberLabel.style.position = 'absolute';
      numberLabel.style.top = '5px';
      numberLabel.style.left = '5px';
      numberLabel.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
      numberLabel.style.color = 'white';
      numberLabel.style.padding = '2px 6px';
      numberLabel.style.borderRadius = '3px';
      numberLabel.style.fontSize = '14px';
      numberLabel.style.fontWeight = 'bold';
      numberLabel.style.zIndex = '10';

      // Monta estrutura visual
      imageContainer.appendChild(link);
      imageContainer.appendChild(numberLabel);
      card.appendChild(imageContainer);

      // Sele√ß√£o
      const select = document.createElement('select');
      select.innerHTML = `
        <option value="">-- Marcar --</option>
        <option value="relevante">Relevante</option>
        <option value="irrelevante">Irrelevante</option>
        <option value="lixo">Lixo</option>
        <option value="utilizado">Utilizado</option>
      `;
      select.style.width = '100%';
      select.style.marginTop = '8px';
      select.value = selecaoSalva; // Preenche com dados do JSON

      // Tag input
      const textarea = document.createElement('input');
      textarea.type = "text";
      textarea.placeholder = "Digite uma tag...";
      textarea.setAttribute("list", `sugestoes-${nome}`);
      textarea.style.width = '100%';
      textarea.style.marginTop = '8px';
      textarea.style.padding = '8px';
      textarea.style.border = '1px solid #ccc';
      textarea.style.borderRadius = '4px';

      const datalist = document.createElement('datalist');
      datalist.id = `sugestoes-${nome}`;

      const cadastrarBtn = document.createElement('button');
      cadastrarBtn.textContent = "Cadastrar Tag";
      cadastrarBtn.style.display = "none";
      cadastrarBtn.style.marginTop = '8px';
      cadastrarBtn.style.padding = '8px 12px';
      cadastrarBtn.style.background = '#28a745';
      cadastrarBtn.style.color = 'white';
      cadastrarBtn.style.border = 'none';
      cadastrarBtn.style.borderRadius = '4px';
      cadastrarBtn.style.cursor = 'pointer';

      const tagList = document.createElement("div");
      tagList.className = "tag-list";
      tagList.style.marginTop = '8px';

      // Preenche tags salvas do JSON
      tagsSalvas.forEach(tag => {
        const tagEl = document.createElement("span");
        tagEl.textContent = "#" + tag;
        tagEl.style.background = '#eee';
        tagEl.style.padding = '4px 8px';
        tagEl.style.borderRadius = '12px';
        tagEl.style.fontSize = '12px';
        tagEl.style.display = 'inline-block';
        tagEl.style.marginRight = '6px';
        tagEl.style.marginBottom = '6px';
        tagList.appendChild(tagEl);
      });

      // Atualiza sugest√µes
      textarea.addEventListener("input", async () => {
        const termo = textarea.value.trim();
        if (!termo) {
          datalist.innerHTML = "";
          cadastrarBtn.style.display = "none";
          return;
        }

        const q = query(
          collection(db, "tags"),
          where("nome", ">=", termo),
          where("nome", "<=", termo + "\uf8ff")
        );
        
        try {
          const snap = await getDocs(q);
          datalist.innerHTML = "";
          let existe = false;
          
          snap.forEach(docSnap => {
            const tag = docSnap.data().nome;
            const opt = document.createElement("option");
            opt.value = tag;
            datalist.appendChild(opt);
            if (tag.toLowerCase() === termo.toLowerCase()) existe = true;
          });
          
          cadastrarBtn.style.display = existe ? "none" : "inline-block";
        } catch (error) {
          console.error("Erro ao buscar tags:", error);
        }
      });

      cadastrarBtn.onclick = async () => {
        const novaTag = textarea.value.trim();
        if (!novaTag) return alert("Digite uma tag!");
        
        try {
          await addDoc(collection(db, "tags"), { nome: novaTag });
          alert(`Tag "${novaTag}" cadastrada!`);
          cadastrarBtn.style.display = "none";
        } catch (e) {
          console.error("Erro ao cadastrar tag:", e);
          alert("Erro ao cadastrar tag");
        }
      };

      const addTagBtn = document.createElement("button");
      addTagBtn.textContent = "Adicionar Tag";
      addTagBtn.style.marginTop = '8px';
      addTagBtn.style.padding = '8px 12px';
      addTagBtn.style.background = '#007bff';
      addTagBtn.style.color = 'white';
      addTagBtn.style.border = 'none';
      addTagBtn.style.borderRadius = '4px';
      addTagBtn.style.cursor = 'pointer';
      addTagBtn.style.marginRight = '8px';

      addTagBtn.onclick = async () => {
        const novaTag = textarea.value.trim();
        if (!novaTag) return alert("Digite uma tag!");
        
        try {
          const docRef = doc(collection(db, NOME_COLECAO), nome);
          
          // Primeiro, cria/atualiza o documento b√°sico
          await setDoc(
            docRef,
            {
              nome: nome,
              link: linkUrl,
              selecao: select.value,
              imagem: `tub/${nome}.png`,
              timestamp: new Date()
            },
            { merge: true }
          );
          
          // Depois adiciona a tag
          await updateDoc(docRef, { 
            tags: arrayUnion(novaTag) 
          });
          
          // Atualiza a interface
          const tagEl = document.createElement("span");
          tagEl.textContent = "#" + novaTag;
          tagEl.style.background = '#eee';
          tagEl.style.padding = '4px 8px';
          tagEl.style.borderRadius = '12px';
          tagEl.style.fontSize = '12px';
          tagEl.style.display = 'inline-block';
          tagEl.style.marginRight = '6px';
          tagEl.style.marginBottom = '6px';
          tagList.appendChild(tagEl);
          
          textarea.value = "";
          cadastrarBtn.style.display = "none";

          // Atualiza cache local
          await atualizarCacheLocal(nome, { tags: [...tagsSalvas, novaTag] });
          
        } catch (e) {
          console.error("Erro ao adicionar tag:", e);
          alert("Erro ao adicionar tag");
        }
      };

      const salvarBtn = document.createElement("button");
      salvarBtn.textContent = "Salvar Card";
      salvarBtn.style.marginTop = '8px';
      salvarBtn.style.padding = '8px 12px';
      salvarBtn.style.background = '#6c757d';
      salvarBtn.style.color = 'white';
      salvarBtn.style.border = 'none';
      salvarBtn.style.borderRadius = '4px';
      salvarBtn.style.cursor = 'pointer';
      salvarBtn.style.width = '100%';

      salvarBtn.onclick = async () => {
        try {
          await setDoc(doc(collection(db, NOME_COLECAO), nome), {
            nome: nome,
            link: linkUrl,
            selecao: select.value,
            imagem: `tub/${nome}.png`,
            timestamp: new Date()
          }, { merge: true });
          
          // Atualiza cache local
          await atualizarCacheLocal(nome, { selecao: select.value });
          
          alert(`Card ${nome} salvo!`);
          aplicarFiltro();
        } catch (e) {
          console.error("Erro ao salvar card:", e);
          alert("Erro ao salvar");
        }
      };

      const controls = document.createElement("div");
      controls.className = "controls";
      controls.style.marginTop = '8px';
      controls.style.display = 'flex';
      controls.style.flexDirection = 'column';
      controls.style.gap = '8px';
      
      controls.appendChild(select);
      controls.appendChild(textarea);
      controls.appendChild(datalist);
      controls.appendChild(cadastrarBtn);
      
      const buttonRow = document.createElement("div");
      buttonRow.style.display = 'flex';
      buttonRow.style.gap = '8px';
      buttonRow.appendChild(addTagBtn);
      buttonRow.appendChild(salvarBtn);
      
      controls.appendChild(buttonRow);
      controls.appendChild(tagList);

      card.appendChild(controls);
      return card;
    }

    async function atualizarCacheLocal(nome, novosDados) {
      if (cacheGlobal && cacheGlobal[nome]) {
        cacheGlobal[nome] = { ...cacheGlobal[nome], ...novosDados };
        localStorage.setItem(`${NOME_COLECAO}_cache`, JSON.stringify(cacheGlobal));
        localStorage.setItem('ultimaSincronizacao', Date.now().toString());
      }
    }

    async function gerarJSONParaAtualizacaoGitHub() {
      try {
        // Busca todos os dados atualizados do Firebase
        const querySnapshot = await getDocs(collection(db, NOME_COLECAO));
        const todosDados = [];
        
        querySnapshot.forEach((doc) => {
          todosDados.push(doc.data());
        });

        // Ordena por nome num√©rico
        todosDados.sort((a, b) => parseInt(a.nome) - parseInt(b.nome));
        
        // Gera o JSON no formato correto
        const jsonAtualizado = todosDados.map(item => ({
          nome: item.nome,
          link: item.link,
          selecao: item.selecao || "",
          imagem: item.imagem || `tub/${item.nome}.png`,
          timestamp: item.timestamp || { seconds: 1761594185, nanoseconds: 698000000 },
          tags: item.tags || []
        }));

        // Cria download do JSON
        const jsonStr = JSON.stringify(jsonAtualizado, null, 2);
        const nomeArquivo = NOME_JSON.replace('.json', '_updated.json');
        downloadJSON(jsonStr, nomeArquivo);
        
        mostrarInstrucoesGitHub(nomeArquivo);
        
      } catch (error) {
        console.error('Erro ao gerar JSON:', error);
        alert('Erro ao gerar JSON atualizado');
      }
    }

    function downloadJSON(jsonStr, filename) {
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function mostrarInstrucoesGitHub(nomeArquivo) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        max-width: 500px;
      `;
      
      modal.innerHTML = `
        <h3>üìù Atualizar GitHub - ${NOME_COLECAO}</h3>
        <p><strong>JSON atualizado gerado com sucesso!</strong></p>
        <ol>
          <li>O arquivo <code>${nomeArquivo}</code> foi baixado</li>
          <li>V√° no seu reposit√≥rio GitHub</li>
          <li>Substitua o arquivo <code>${NOME_JSON}</code> por este novo</li>
          <li>Fa√ßa commit das mudan√ßas</li>
        </ol>
        <p><em>‚úÖ Todos os dispositivos ser√£o atualizados em 1-2 minutos</em></p>
        <button onclick="this.parentElement.remove()" style="padding: 8px 16px; margin-top: 10px;">Fechar</button>
      `;
      
      document.body.appendChild(modal);
    }

    async function loadAllCards() {
      loadingIndicator.style.display = 'flex';
      feed.setAttribute('aria-busy', 'true');
      
      try {
        // Carrega dados do JSON local
        const dados = await carregarDadosInteligente();
        
        // Limpa o feed
        feed.innerHTML = '';
        
        // Cria cards para todos os itens do JSON
        Object.keys(dados).sort((a, b) => parseInt(a) - parseInt(b)).forEach(nome => {
          const card = createCard(nome, dados[nome]);
          feed.appendChild(card);
        });
        
      } catch (error) {
        console.error("Erro ao carregar cards:", error);
        alert("Erro ao carregar os dados");
      } finally {
        loadingIndicator.style.display = 'none';
        feed.setAttribute('aria-busy', 'false');
        aplicarFiltro();
      }
    }

    // Bot√£o para gerar JSON atualizado
    document.getElementById('btn-atualizar-json').addEventListener('click', async () => {
      await gerarJSONParaAtualizacaoGitHub();
    });

    // Carrega todos os cards quando a p√°gina √© carregada
    loadAllCards();
  </script>
</body>
</html>
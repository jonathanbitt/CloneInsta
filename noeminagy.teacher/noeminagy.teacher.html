<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clone Instagram - Paginação Inteligente (último alterado)</title>
  <style>
    :root{--bg:#fafafa;--card:#fff;--muted:#8e8e8e;--accent:#0095f6}
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#111}
    header{height:66px;background:#fff;border-bottom:1px solid #dbdbdb;display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:10}
    .brand h1{font-family:'Grand Hotel',cursive;font-size:30px;margin:0}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:24px}
    .card{background:var(--card);border:1px solid #dbdbdb;border-radius:3px;padding:8px;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
    .thumb{width:100%;aspect-ratio:319/486;object-fit:cover;border-radius:2px;display:block;background:#efefef}
    button{padding:8px 12px;border-radius:4px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .loading{display:flex;align-items:center;justify-content:center;padding:16px;color:var(--muted)}
    .sync-status{position:fixed;top:70px;right:20px;padding:8px 12px;border-radius:4px;font-size:12px;z-index:1000}
    .synced{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .pending{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}
    .error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
  </style>
</head>
<body>
  <header>
    <div class="brand"><h1>Instagram</h1></div>
    <nav style="display:flex;gap:12px;align-items:center">
      <button id="btn-carregar-mais">Carregar Mais (100)</button>
      <button id="btn-resetar">Reiniciar</button>
    </nav>
  </header>

  <div id="syncStatus" class="sync-status" style="display:none"></div>
  <main class="container" style="max-width:980px;margin:28px auto">
    <section id="feed" class="grid"></section>
  </main>

  <div id="loadingIndicator" class="loading" style="display:none">
    <div class="spinner" aria-hidden="true"></div>
    <span style="margin-left:8px">Carregando...</span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc, collection 
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // ========================
    // CONFIGURAÇÕES FIREBASE
    // ========================
    const firebaseConfig = {
      apiKey: "AIzaSyCNgDqkqhsFQY7bfrWK2_VPtGUoEyyIBq4",
      authDomain: "trechos-c7fba.firebaseapp.com",
      projectId: "trechos-c7fba",
      storageBucket: "trechos-c7fba.appspot.com",
      messagingSenderId: "334052038527",
      appId: "1:334052038527:web:797e8967eaef7b198a2c4a",
      measurementId: "G-FL2Q1KLJMT"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const NOME_COLECAO = "noeminagy.teacher";
    const LIMITE = 100;

    const feed = document.getElementById("feed");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const syncStatus = document.getElementById("syncStatus");
    const btnCarregarMais = document.getElementById("btn-carregar-mais");
    const btnResetar = document.getElementById("btn-resetar");

    // ========================
    // FUNÇÕES DE STATUS
    // ========================
    function setStatus(msg, tipo="synced") {
      syncStatus.textContent = msg;
      syncStatus.className = `sync-status ${tipo}`;
      syncStatus.style.display = "block";
      if (tipo === "synced") setTimeout(()=>syncStatus.style.display="none",3000);
    }

    // ========================
    // GERENCIAMENTO META
    // ========================
    async function getMeta() {
      const ref = doc(db, NOME_COLECAO, "meta");
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { lastLoaded: 0, lastEdited: 0, lastUpdated: Date.now() });
        return { lastLoaded: 0, lastEdited: 0 };
      }
      return snap.data();
    }

    async function updateMeta(fields) {
      await setDoc(doc(db, NOME_COLECAO, "meta"), { ...fields, lastUpdated: Date.now() }, { merge: true });
    }

    async function resetarMeta() {
      await setDoc(doc(db, NOME_COLECAO, "meta"), { lastLoaded: 0, lastEdited: 0, lastUpdated: Date.now() }, { merge: true });
      localStorage.removeItem(`${NOME_COLECAO}_lastLoaded`);
      localStorage.removeItem(`${NOME_COLECAO}_lastEdited`);
      setStatus("Meta resetada (voltou ao início)", "pending");
    }

    // ========================
    // CARREGAMENTO PAGINADO
    // ========================
    async function carregarLote() {
      loadingIndicator.style.display = "flex";
      try {
        const meta = await getMeta();
        const base = parseInt(meta.lastEdited || 0);
        const inicio = base + 1;
        const fim = inicio + LIMITE - 1;
        console.log(`Carregando documentos ${inicio} a ${fim}`);

        const novosDados = {};
        for (let i = inicio; i <= fim; i++) {
          const docRef = doc(collection(db, NOME_COLECAO), String(i));
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const d = docSnap.data();
            novosDados[String(i)] = {
              nome: d.nome || String(i),
              link: d.link || "#",
              selecao: d.selecao || "",
              imagem: d.imagem || `tub/${i}.png`
            };
          }
        }

        Object.keys(novosDados).forEach(nome => {
          feed.appendChild(criarCard(nome, novosDados[nome]));
        });

        await updateMeta({ lastLoaded: fim });
        localStorage.setItem(`${NOME_COLECAO}_lastLoaded`, fim);
        setStatus(`Carregados ${Object.keys(novosDados).length} documentos (${inicio}-${fim})`, "synced");

      } catch (e) {
        console.error("Erro ao carregar lote:", e);
        setStatus("Erro ao carregar lote", "error");
      } finally {
        loadingIndicator.style.display = "none";
      }
    }

    // ========================
    // UI
    // ========================
    function criarCard(nome, dados) {
      const card = document.createElement("article");
      card.className = "card";

      const img = document.createElement("img");
      img.className = "thumb";
      img.src = dados.imagem;
      img.alt = nome;

      const numberLabel = document.createElement("div");
      numberLabel.textContent = nome;
      numberLabel.style = "position:absolute;top:5px;left:5px;background:rgba(0,0,0,0.7);color:#fff;padding:2px 6px;border-radius:3px;font-size:14px;font-weight:bold";

      const wrapper = document.createElement("div");
      wrapper.style.position = "relative";
      wrapper.appendChild(img);
      wrapper.appendChild(numberLabel);

      const salvarBtn = document.createElement("button");
      salvarBtn.textContent = "Salvar (Simular Alteração)";
      salvarBtn.style.display = "block";
      salvarBtn.style.marginTop = "8px";
      salvarBtn.onclick = async () => {
        await updateMeta({ lastEdited: parseInt(nome) });
        setStatus(`Último alterado: ${nome}`, "pending");
      };

      card.appendChild(wrapper);
      card.appendChild(salvarBtn);
      return card;
    }

    // ========================
    // EVENTOS
    // ========================
    btnCarregarMais.onclick = carregarLote;
    btnResetar.onclick = async () => {
      if (confirm("Deseja realmente resetar o ponto de carregamento?")) {
        await resetarMeta();
        feed.innerHTML = "";
      }
    };

    // ========================
    // INICIALIZAÇÃO
    // ========================
    window.addEventListener("load", async () => {
      const meta = await getMeta();
      const base = parseInt(meta.lastEdited || 0);
      setStatus(`Retomando a partir do documento ${base + 1}`, "pending");
      await carregarLote();
    });
  </script>
</body>
</html>

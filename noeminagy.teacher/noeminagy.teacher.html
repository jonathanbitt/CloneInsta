<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clone Instagram - Paginação + Tags (Links ocultos)</title>
  <style>
    :root{--bg:#fafafa;--card:#fff;--muted:#8e8e8e;--accent:#0095f6}
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#111}
    header{height:66px;background:#fff;border-bottom:1px solid #dbdbdb;display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:10}
    .brand h1{font-family:'Grand Hotel',cursive;font-size:30px;margin:0}
    .container{max-width:980px;margin:28px auto;}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:24px}
    .card{background:var(--card);border:1px solid #dbdbdb;border-radius:3px;padding:8px;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
    .thumb{width:100%;aspect-ratio:319/486;object-fit:cover;border-radius:2px;display:block;background:#efefef}
    button{padding:8px 12px;border-radius:4px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    input,select{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:4px}
    .tag-list{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .tag-list span{background:#eee;padding:4px 8px;border-radius:12px;font-size:12px}
    .loading{display:flex;align-items:center;justify-content:center;padding:16px;color:var(--muted)}
    .sync-status{position:fixed;top:70px;right:20px;padding:8px 12px;border-radius:4px;font-size:12px;z-index:1000}
    .synced{background:#d4edda;color:#155724;border:1px solid #c3e6cb}
    .pending{background:#fff3cd;color:#856404;border:1px solid #ffeaa7}
    .error{background:#f8d7da;color:#721c24;border:1px solid #f5c6cb}
    .cadastrar-tag-btn {
      background: #28a745;
      margin-top: 8px;
      display: none;
    }
    .button-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    .suggestions-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      z-index: 20;
      display: none;
      flex-direction: column;
      padding: 10px;
    }
    .suggestions-header {
      color: white;
      font-size: 14px;
      font-weight: bold;
      margin-bottom: 8px;
      text-align: center;
      border-bottom: 1px solid #444;
      padding-bottom: 5px;
    }
    .suggestions-list {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .suggestion-item {
      padding: 8px 10px;
      background: #333;
      color: white;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid #555;
      transition: all 0.2s ease;
      font-size: 13px;
    }
    .suggestion-item:hover {
      background: #0095f6;
      transform: translateY(-1px);
    }
    .no-suggestions {
      color: #999;
      text-align: center;
      padding: 20px;
      font-size: 13px;
    }
    .suggestions-close {
      position: absolute;
      top: 5px;
      right: 8px;
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .suggestions-close:hover {
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }

    /* Media Queries para responsividade - IGUAL À PÁGINA DE REFERÊNCIA */
    @media(min-width:1180px){
      .container{max-width:100%;margin:28px;}
    }
    @media(max-width:1000px){
      .grid{grid-template-columns:repeat(3,1fr)}
    }
    @media(max-width:720px){
      .grid{grid-template-columns:repeat(2,1fr)}
    }
    @media(max-width:460px){
      .grid{grid-template-columns:repeat(1,1fr)}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand"><h1>Instagram</h1></div>
    <nav style="display:flex;gap:12px;align-items:center">
      <button id="btn-carregar-mais">Carregar +100</button>
      <button id="btn-resetar">Reiniciar</button>
    </nav>
  </header>

  <div id="syncStatus" class="sync-status" style="display:none"></div>
  
  <main class="container">
    <section id="feed" class="grid"></section>
  </main>

  <div id="loadingIndicator" class="loading" style="display:none">
    <span>Carregando...</span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { 
      getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, query, where, arrayUnion
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // ========================
    // CONFIG FIREBASE
    // ========================
    const firebaseConfig = {
      apiKey: "AIzaSyCNgDqkqhsFQY7bfrWK2_VPtGUoEyyIBq4",
      authDomain: "trechos-c7fba.firebaseapp.com",
      projectId: "trechos-c7fba",
      storageBucket: "trechos-c7fba.appspot.com",
      messagingSenderId: "334052038527",
      appId: "1:334052038527:web:797e8967eaef7b198a2c4a",
      measurementId: "G-FL2Q1KLJMT"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const NOME_COLECAO = "noeminagy.teacher";
    const LIMITE = 100;

    const feed = document.getElementById("feed");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const syncStatus = document.getElementById("syncStatus");
    const btnCarregarMais = document.getElementById("btn-carregar-mais");
    const btnResetar = document.getElementById("btn-resetar");

    // ========================
    // STATUS
    // ========================
    function setStatus(msg, tipo="synced") {
      syncStatus.textContent = msg;
      syncStatus.className = `sync-status ${tipo}`;
      syncStatus.style.display = "block";
      if (tipo === "synced") setTimeout(()=>syncStatus.style.display="none",3000);
    }

    // ========================
    // META
    // ========================
    async function getMeta() {
      const ref = doc(db, NOME_COLECAO, "meta");
      const snap = await getDoc(ref);
      if (!snap.exists()) {
        await setDoc(ref, { lastLoaded: 0, lastEdited: 0, lastUpdated: Date.now() });
        return { lastLoaded: 0, lastEdited: 0 };
      }
      return snap.data();
    }

    async function updateMeta(fields) {
      await setDoc(doc(db, NOME_COLECAO, "meta"), { ...fields, lastUpdated: Date.now() }, { merge: true });
    }

    async function resetarMeta() {
      await setDoc(doc(db, NOME_COLECAO, "meta"), { lastLoaded: 0, lastEdited: 0, lastUpdated: Date.now() }, { merge: true });
      feed.innerHTML = "";
      setStatus("Meta resetada", "pending");
    }

    // ========================
    // CARREGAR LOTE
    // ========================
    async function carregarLote() {
      loadingIndicator.style.display = "flex";
      try {
        const meta = await getMeta();
        const base = parseInt(meta.lastEdited || 0);
        const inicio = base + 1;
        const fim = inicio + LIMITE - 1;

        const novosDados = {};
        for (let i = inicio; i <= fim; i++) {
          const docRef = doc(collection(db, NOME_COLECAO), String(i));
          const docSnap = await getDoc(docRef);
          if (docSnap.exists()) {
            const d = docSnap.data();
            novosDados[String(i)] = {
              nome: d.nome || String(i),
              link: d.link || "#",
              selecao: d.selecao || "",
              imagem: d.imagem || `tub/${i}.png`,
              tags: d.tags || []
            };
          }
        }

        Object.keys(novosDados).forEach(nome => {
          feed.appendChild(criarCard(nome, novosDados[nome]));
        });

        await updateMeta({ lastLoaded: fim });
        setStatus(`Carregados ${Object.keys(novosDados).length} documentos (${inicio}-${fim})`, "synced");
      } catch (e) {
        console.error("Erro ao carregar lote:", e);
        setStatus("Erro ao carregar lote", "error");
      } finally {
        loadingIndicator.style.display = "none";
      }
    }

    // ========================
    // TAGS
    // ========================
    async function buscarTags(termo) {
      const q = query(
        collection(db, "tags"),
        where("nome", ">=", termo),
        where("nome", "<=", termo + "\uf8ff")
      );
      const snap = await getDocs(q);
      return snap.docs.map(d => d.data().nome);
    }

    async function cadastrarTag(novaTag) {
      await addDoc(collection(db, "tags"), { nome: novaTag });
    }

    async function adicionarTagAoCard(nome, novaTag) {
      const ref = doc(collection(db, NOME_COLECAO), nome);
      await setDoc(ref, { tags: arrayUnion(novaTag) }, { merge: true });
      await updateMeta({ lastEdited: parseInt(nome) });
    }

    // ========================
    // CARD
    // ========================
    function criarCard(nome, dados) {
      const card = document.createElement("article");
      card.className = "card";

      // Container da imagem
      const imageContainer = document.createElement("div");
      imageContainer.style.position = "relative";

      // Link clicável (abre o Instagram)
      const link = document.createElement("a");
      link.href = dados.link || "#";
      link.target = "_blank";

      const img = document.createElement("img");
      img.className = "thumb";
      img.src = dados.imagem;
      img.alt = nome;
      link.appendChild(img);

      const label = document.createElement("div");
      label.textContent = nome;
      label.style = "position:absolute;top:5px;left:5px;background:rgba(0,0,0,0.7);color:#fff;padding:2px 6px;border-radius:3px;font-size:14px;font-weight:bold;z-index:15";

      imageContainer.append(link, label);
      card.appendChild(imageContainer);

      // Overlay de sugestões (sobrepõe a imagem)
      const suggestionsOverlay = document.createElement("div");
      suggestionsOverlay.className = "suggestions-overlay";

      // Botão fechar
      const closeBtn = document.createElement("button");
      closeBtn.className = "suggestions-close";
      closeBtn.innerHTML = "×";
      closeBtn.onclick = () => {
        suggestionsOverlay.style.display = "none";
      };

      // Header das sugestões
      const suggestionsHeader = document.createElement("div");
      suggestionsHeader.className = "suggestions-header";
      suggestionsHeader.textContent = "Sugestões de Tags";

      // Lista de sugestões
      const suggestionsList = document.createElement("div");
      suggestionsList.className = "suggestions-list";

      suggestionsOverlay.appendChild(closeBtn);
      suggestionsOverlay.appendChild(suggestionsHeader);
      suggestionsOverlay.appendChild(suggestionsList);

      imageContainer.appendChild(suggestionsOverlay);

      // Select para marcação - ADICIONADO AQUI
      const select = document.createElement("select");
      select.style.width = "100%";
      select.style.marginTop = "8px";
      select.innerHTML = `
        <option value="">-- Marcar --</option>
        <option value="relevante">Relevante</option>
        <option value="irrelevante">Irrelevante</option>
        <option value="lixo">Lixo</option>
        <option value="utilizado">Utilizado</option>
      `;
      
      // Preenche o valor salvo se existir
      if (dados.selecao) {
        select.value = dados.selecao;
      }

      // Campo de tag
      const inputTag = document.createElement("input");
      inputTag.placeholder = "Digite uma tag...";

      // Botão para cadastrar nova tag (aparece apenas quando a tag não existe)
      const cadastrarBtn = document.createElement("button");
      cadastrarBtn.textContent = "Cadastrar Tag";
      cadastrarBtn.className = "cadastrar-tag-btn";
      cadastrarBtn.style.display = "none";

      cadastrarBtn.onclick = async () => {
        const novaTag = inputTag.value.trim();
        if (!novaTag) return alert("Digite uma tag!");
        await cadastrarTag(novaTag);
        alert(`Tag "${novaTag}" cadastrada!`);
        cadastrarBtn.style.display = "none";
        suggestionsOverlay.style.display = "none";
      };

      // Atualiza sugestões conforme digitação
      inputTag.addEventListener("input", async () => {
        const termo = inputTag.value.trim();
        suggestionsList.innerHTML = "";
        
        if (!termo) {
          suggestionsOverlay.style.display = "none";
          cadastrarBtn.style.display = "none";
          return;
        }

        const tags = await buscarTags(termo);
        let tagExiste = false;
        
        if (tags.length > 0) {
          tags.forEach(tag => {
            const suggestionItem = document.createElement("div");
            suggestionItem.className = "suggestion-item";
            suggestionItem.textContent = tag;
            suggestionItem.onclick = () => {
              inputTag.value = tag;
              suggestionsOverlay.style.display = "none";
              cadastrarBtn.style.display = "none";
            };
            suggestionsList.appendChild(suggestionItem);
            
            if (tag.toLowerCase() === termo.toLowerCase()) {
              tagExiste = true;
            }
          });
          suggestionsOverlay.style.display = "flex";
        } else {
          // Mostra mensagem quando não há sugestões
          const noSuggestions = document.createElement("div");
          noSuggestions.className = "no-suggestions";
          noSuggestions.textContent = "Nenhuma tag encontrada";
          suggestionsList.appendChild(noSuggestions);
          suggestionsOverlay.style.display = "flex";
        }

        // Mostra botão "Cadastrar Tag" apenas se a tag não existe
        cadastrarBtn.style.display = tagExiste ? "none" : "block";
      });

      // Botão adicionar tag ao card
      const btnAddTag = document.createElement("button");
      btnAddTag.textContent = "Adicionar Tag";

      // Botão salvar (marca último editado)
      const salvarBtn = document.createElement("button");
      salvarBtn.textContent = "Salvar Card";
      salvarBtn.style.background = "#6c757d";

      // Container para os botões
      const buttonRow = document.createElement("div");
      buttonRow.className = "button-row";
      buttonRow.appendChild(btnAddTag);
      buttonRow.appendChild(salvarBtn);

      // Lista de tags
      const tagList = document.createElement("div");
      tagList.className = "tag-list";
      dados.tags.forEach(tag => {
        const t = document.createElement("span");
        t.textContent = "#" + tag;
        tagList.appendChild(t);
      });

      // Ação do botão adicionar tag
      btnAddTag.onclick = async () => {
        const novaTag = inputTag.value.trim();
        if (!novaTag) return alert("Digite uma tag!");
        
        await adicionarTagAoCard(nome, novaTag);
        const el = document.createElement("span");
        el.textContent = "#" + novaTag;
        tagList.appendChild(el);
        inputTag.value = "";
        cadastrarBtn.style.display = "none";
        suggestionsOverlay.style.display = "none";
        setStatus(`Tag "${novaTag}" adicionada ao card ${nome}`, "synced");
      };

      // Ação do botão salvar
      salvarBtn.onclick = async () => {
        const ref = doc(collection(db, NOME_COLECAO), nome);
        await setDoc(ref, {
          nome,
          link: dados.link,
          imagem: dados.imagem,
          selecao: select.value, // Salva a seleção atual
          timestamp: new Date()
        }, { merge: true });
        await updateMeta({ lastEdited: parseInt(nome) });
        setStatus(`Card ${nome} salvo`, "pending");
      };

      // Adiciona os elementos na ordem correta
      card.append(select, inputTag, cadastrarBtn, buttonRow, tagList);
      return card;
    }

    // ========================
    // EVENTOS
    // ========================
    btnCarregarMais.onclick = carregarLote;
    btnResetar.onclick = resetarMeta;

    window.addEventListener("load", async () => {
      const meta = await getMeta();
      const base = parseInt(meta.lastEdited || 0);
      setStatus(`Retomando a partir do documento ${base + 1}`, "pending");
      await carregarLote();
    });
  </script>
</body>
</html>
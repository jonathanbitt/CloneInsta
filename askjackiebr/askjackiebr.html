<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clone Instagram - Desktop (grid 4 por linha)</title>
  <style>
    :root{--bg:#fafafa;--card:#fff;--muted:#8e8e8e;--accent:#0095f6}
    html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial;background:var(--bg);color:#111}
    header{height:66px;background:#fff;border-bottom:1px solid #dbdbdb;display:flex;align-items:center;justify-content:space-between;padding:0 24px;position:sticky;top:0;z-index:10}
    .brand{display:flex;align-items:center;gap:16px}
    .brand h1{font-family:'Grand Hotel',cursive;font-size:30px;margin:0}
    .search{width:300px;display:flex;align-items:center;gap:12px;}
    .container{max-width:980px;margin:28px auto;}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:24px}
    .card{background:var(--card);border:1px solid #dbdbdb;border-radius:3px;padding:8px;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
    .thumb{width:100%;aspect-ratio:319/486;object-fit:cover;border-radius:2px;display:block;background:#efefef}
    .controls{margin-top:8px;display:flex;flex-direction:column;gap:8px}
    select, input, button{font-size:14px}
    select{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px;background:#fff}
    input[type="text"]{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px}
    button{align-self:flex-end;padding:8px 12px;border-radius:4px;border:0;background:var(--accent);color:#fff;cursor:pointer}
    .tag-list{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .tag-list span{background:#eee;padding:4px 8px;border-radius:12px;font-size:12px}
    .loading{display:flex;align-items:center;justify-content:center;padding:16px;color:var(--muted)}
    @media(min-width:1180px){.page{display:block};.container{max-width:100%;margin:28px;}}
    @media(max-width:1000px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:460px){.grid{grid-template-columns:repeat(1,1fr)}}
    .spinner{width:28px;height:28px;border-radius:50%;border:4px solid #e9e9e9;border-top-color:var(--muted);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <div class="brand"><h1>Instagram</h1></div>
    <div class="search">
      <input type="search" placeholder="Pesquisar" style="width:200px;padding:8px;border-radius:6px;border:1px solid #dbdbdb">
    <select id="filtro-selecao" style="padding:6px;border-radius:6px;border:1px solid #ccc;">
  <option value="">-- Todos --</option>
  <option value="nao-classificado">Não Classificado</option>
  <option value="relevante">Relevante</option>
  <option value="irrelevante">Irrelevante</option>
  <option value="lixo">Lixo</option>
  <option value="utilizado">Utilizado</option>
</select>
    </div>
    <nav style="display:flex;gap:12px;align-items:center">
      <button aria-label="Novo" style="padding:8px 10px;border-radius:6px;border:1px solid #dbdbdb;background:#fff">Novo</button>
      <button aria-label="Perfil" style="padding:8px 10px;border-radius:6px;border:1px solid #dbdbdb;background:#fff">Perfil</button>
    </nav>
  </header>

  <main class="container page">
    <section id="feed" class="grid" aria-live="polite" aria-busy="false"></section>
  </main>

  <div id="loadingIndicator" class="loading" style="display:none">
    <div class="spinner" aria-hidden="true"></div>
    <span style="margin-left:8px">Carregando...</span>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { 
      getFirestore, collection, doc, setDoc, getDoc, addDoc, query, where, getDocs, updateDoc, arrayUnion 
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCNgDqkqhsFQY7bfrWK2_VPtGUoEyyIBq4",
      authDomain: "trechos-c7fba.firebaseapp.com",
      projectId: "trechos-c7fba",
      storageBucket: "trechos-c7fba.appspot.com",
      messagingSenderId: "334052038527",
      appId: "1:334052038527:web:797e8967eaef7b198a2c4a",
      measurementId: "G-FL2Q1KLJMT"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const feed = document.getElementById('feed');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const filtroSelect = document.getElementById("filtro-selecao");

async function carregarLinksDoFirebase() {
  try {
    const querySnapshot = await getDocs(collection(db, "askjackiebr"));
    const linksMap = {};
    
    querySnapshot.forEach((doc) => {
      const data = doc.data();
      if (data.nome && data.link) {
        linksMap[data.nome] = data.link;
      }
    });
    
    return linksMap;
  } catch (error) {
    console.error("Erro ao carregar links do Firebase:", error);
    return {};
  }
}

    function aplicarFiltro() {
      const valorFiltro = filtroSelect.value;
      const cards = feed.querySelectorAll(".card");
      
      cards.forEach(card => {
        const select = card.querySelector("select");
        const selectValue = select.value;
        
        switch(valorFiltro) {
          case "nao-classificado":
            card.style.display = (selectValue === "" || selectValue === "-- Marcar --") ? "block" : "none";
            break;
          case "":
            card.style.display = "block"; // Todos
            break;
          default:
            card.style.display = selectValue === valorFiltro ? "block" : "none";
        }
      });
    }

    filtroSelect.addEventListener("change", aplicarFiltro);

    
    function createCard(idx, linksMap) {
  const card = document.createElement('article');
  card.className = 'card';
  const nome = (idx + 1).toString();
  
  // Obter o link do Firebase ou usar fallback
  const linkUrl = linksMap[nome] || '#';

  // Container para a imagem e o número
  const imageContainer = document.createElement('div');
  imageContainer.style.position = 'relative';
  imageContainer.style.display = 'inline-block';
  imageContainer.style.width = '100%';

  // Link + imagem
  const link = document.createElement('a');
  link.href = linkUrl;
  link.target = '_blank';
  link.style.display = 'block';

  const img = document.createElement('img');
  img.className = 'thumb';
  img.src = `tub/${nome}.png`;
  img.alt = `Thumbnail ${nome}`;
  img.style.width = '100%';
  img.style.height = 'auto';
  img.style.display = 'block';
  link.appendChild(img);

  // Número sobre a imagem
  const numberLabel = document.createElement('div');
  numberLabel.textContent = nome;
  numberLabel.style.position = 'absolute';
  numberLabel.style.top = '5px';
  numberLabel.style.left = '5px';
  numberLabel.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
  numberLabel.style.color = 'white';
  numberLabel.style.padding = '2px 6px';
  numberLabel.style.borderRadius = '3px';
  numberLabel.style.fontSize = '14px';
  numberLabel.style.fontWeight = 'bold';
  numberLabel.style.zIndex = '10';

  // Monta estrutura visual
  imageContainer.appendChild(link);
  imageContainer.appendChild(numberLabel);
  card.appendChild(imageContainer);

  // Seleção
  const select = document.createElement('select');
  select.innerHTML = `
    <option value="">-- Marcar --</option>
    <option value="relevante">Relevante</option>
    <option value="irrelevante">Irrelevante</option>
    <option value="lixo">Lixo</option>
    <option value="utilizado">Utilizado</option>
  `;
  select.style.width = '100%';
  select.style.marginTop = '8px';

  // Tag input
  const textarea = document.createElement('input');
  textarea.type = "text";
  textarea.placeholder = "Digite uma tag...";
  textarea.setAttribute("list", `sugestoes-${nome}`);
  textarea.style.width = '100%';
  textarea.style.marginTop = '8px';
  textarea.style.padding = '8px';
  textarea.style.border = '1px solid #ccc';
  textarea.style.borderRadius = '4px';

  const datalist = document.createElement('datalist');
  datalist.id = `sugestoes-${nome}`;

  const cadastrarBtn = document.createElement('button');
  cadastrarBtn.textContent = "Cadastrar Tag";
  cadastrarBtn.style.display = "none";
  cadastrarBtn.style.marginTop = '8px';
  cadastrarBtn.style.padding = '8px 12px';
  cadastrarBtn.style.background = '#28a745';
  cadastrarBtn.style.color = 'white';
  cadastrarBtn.style.border = 'none';
  cadastrarBtn.style.borderRadius = '4px';
  cadastrarBtn.style.cursor = 'pointer';

  const tagList = document.createElement("div");
  tagList.className = "tag-list";
  tagList.style.marginTop = '8px';

  // Atualiza sugestões
  textarea.addEventListener("input", async () => {
    const termo = textarea.value.trim();
    if (!termo) {
      datalist.innerHTML = "";
      cadastrarBtn.style.display = "none";
      return;
    }

    const q = query(
      collection(db, "tags"),
      where("nome", ">=", termo),
      where("nome", "<=", termo + "\uf8ff")
    );
    
    try {
      const snap = await getDocs(q);
      datalist.innerHTML = "";
      let existe = false;
      
      snap.forEach(docSnap => {
        const tag = docSnap.data().nome;
        const opt = document.createElement("option");
        opt.value = tag;
        datalist.appendChild(opt);
        if (tag.toLowerCase() === termo.toLowerCase()) existe = true;
      });
      
      cadastrarBtn.style.display = existe ? "none" : "inline-block";
    } catch (error) {
      console.error("Erro ao buscar tags:", error);
    }
  });

  cadastrarBtn.onclick = async () => {
    const novaTag = textarea.value.trim();
    if (!novaTag) return alert("Digite uma tag!");
    
    try {
      await addDoc(collection(db, "tags"), { nome: novaTag });
      alert(`Tag "${novaTag}" cadastrada!`);
      cadastrarBtn.style.display = "none";
    } catch (e) {
      console.error("Erro ao cadastrar tag:", e);
      alert("Erro ao cadastrar tag");
    }
  };

  const addTagBtn = document.createElement("button");
  addTagBtn.textContent = "Adicionar Tag";
  addTagBtn.style.marginTop = '8px';
  addTagBtn.style.padding = '8px 12px';
  addTagBtn.style.background = '#007bff';
  addTagBtn.style.color = 'white';
  addTagBtn.style.border = 'none';
  addTagBtn.style.borderRadius = '4px';
  addTagBtn.style.cursor = 'pointer';
  addTagBtn.style.marginRight = '8px';

  addTagBtn.onclick = async () => {
    const novaTag = textarea.value.trim();
    if (!novaTag) return alert("Digite uma tag!");
    
    try {
      const docRef = doc(collection(db, "askjackiebr"), nome);
      
      // Primeiro, cria/atualiza o documento básico
      await setDoc(
        docRef,
        {
          nome: nome,
          link: linkUrl, // Usa o link do Firebase
          selecao: select.value,
          imagem: `tub/${nome}.png`,
          timestamp: new Date()
        },
        { merge: true }
      );
      
      // Depois adiciona a tag
      await updateDoc(docRef, { 
        tags: arrayUnion(novaTag) 
      });
      
      // Atualiza a interface
      const tagEl = document.createElement("span");
      tagEl.textContent = "#" + novaTag;
      tagEl.style.background = '#eee';
      tagEl.style.padding = '4px 8px';
      tagEl.style.borderRadius = '12px';
      tagEl.style.fontSize = '12px';
      tagEl.style.display = 'inline-block';
      tagEl.style.marginRight = '6px';
      tagEl.style.marginBottom = '6px';
      tagList.appendChild(tagEl);
      
      textarea.value = "";
      cadastrarBtn.style.display = "none";
    } catch (e) {
      console.error("Erro ao adicionar tag:", e);
      alert("Erro ao adicionar tag");
    }
  };

  const salvarBtn = document.createElement("button");
  salvarBtn.textContent = "Salvar Card";
  salvarBtn.style.marginTop = '8px';
  salvarBtn.style.padding = '8px 12px';
  salvarBtn.style.background = '#6c757d';
  salvarBtn.style.color = 'white';
  salvarBtn.style.border = 'none';
  salvarBtn.style.borderRadius = '4px';
  salvarBtn.style.cursor = 'pointer';
  salvarBtn.style.width = '100%';

  salvarBtn.onclick = async () => {
    try {
      await setDoc(doc(collection(db, "askjackiebr"), nome), {
        nome: nome,
        link: linkUrl, // Usa o link do Firebase
        selecao: select.value,
        imagem: `tub/${nome}.png`,
        timestamp: new Date()
      }, { merge: true });
      
      alert(`Card ${nome} salvo!`);
      aplicarFiltro();
    } catch (e) {
      console.error("Erro ao salvar card:", e);
      alert("Erro ao salvar");
    }
  };

  // Carrega dados salvos
  (async () => {
    try {
      const docRef = doc(collection(db, "askjackiebr"), nome);
      const snap = await getDoc(docRef);
      
      if (snap.exists()) {
        const data = snap.data();
        
        // Preenche a seleção
        if (data.selecao) {
          select.value = data.selecao;
        }
        
        // Preenche as tags
        if (data.tags && data.tags.length > 0) {
          data.tags.forEach(t => {
            const tagEl = document.createElement("span");
            tagEl.textContent = "#" + t;
            tagEl.style.background = '#eee';
            tagEl.style.padding = '4px 8px';
            tagEl.style.borderRadius = '12px';
            tagEl.style.fontSize = '12px';
            tagEl.style.display = 'inline-block';
            tagEl.style.marginRight = '6px';
            tagEl.style.marginBottom = '6px';
            tagList.appendChild(tagEl);
          });
        }
      }
    } catch (error) {
      console.error("Erro ao carregar dados do card:", error);
    }
  })();

  const controls = document.createElement("div");
  controls.className = "controls";
  controls.style.marginTop = '8px';
  controls.style.display = 'flex';
  controls.style.flexDirection = 'column';
  controls.style.gap = '8px';
  
  controls.appendChild(select);
  controls.appendChild(textarea);
  controls.appendChild(datalist);
  controls.appendChild(cadastrarBtn);
  
  const buttonRow = document.createElement("div");
  buttonRow.style.display = 'flex';
  buttonRow.style.gap = '8px';
  buttonRow.appendChild(addTagBtn);
  buttonRow.appendChild(salvarBtn);
  
  controls.appendChild(buttonRow);
  controls.appendChild(tagList);

  card.appendChild(controls);
  return card;
}


  async function loadAllCards() {
    loadingIndicator.style.display = 'flex';
    feed.setAttribute('aria-busy', 'true');
    
    try {
      // Carrega os links do Firebase
      const linksMap = await carregarLinksDoFirebase();
      
      // Determina quantos cards criar baseado no maior número encontrado
      const maxCards = Math.max(...Object.keys(linksMap).map(Number)) || 0;
      
      // Limpa o feed antes de adicionar novos cards
      feed.innerHTML = '';
      
      for(let i = 1; i <= maxCards; i++) {
        const nome = i.toString();
        const card = createCard(i - 1, linksMap); // -1 porque o índice começa em 0
        feed.appendChild(card);
      }
      
    } catch (error) {
      console.error("Erro ao carregar cards:", error);
      alert("Erro ao carregar os dados do Firebase");
    } finally {
      loadingIndicator.style.display = 'none';
      feed.setAttribute('aria-busy', 'false');
      aplicarFiltro();
    }
  }

    // Carrega todos os cards quando a página é carregada
    loadAllCards();
  </script>
</body>
</html>